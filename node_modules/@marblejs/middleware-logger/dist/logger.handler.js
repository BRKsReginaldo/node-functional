"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const logger_factory_1 = require("./logger.factory");
const logger_util_1 = require("./logger.util");
exports.loggerHandler = (res, opts) => (stamp) => rxjs_1.fromEvent(res, 'finish')
    .pipe(operators_1.take(1), operators_1.mapTo(stamp.value), operators_1.map(req => ({ req, res })), operators_1.filter(logger_util_1.isNotSilent(opts)), operators_1.filter(logger_util_1.filterResponse(opts)))
    .subscribe(() => {
    const { info } = console;
    const log = logger_factory_1.factorizeLog(res, stamp);
    const streamLog = log({ colorize: false, timestamp: true });
    const consoleLog = log({ colorize: true });
    opts.stream
        ? logger_util_1.writeToStream(opts.stream, streamLog)
        : info(consoleLog);
});
