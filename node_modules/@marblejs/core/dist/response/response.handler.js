"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const url = require("url");
const rxjs_1 = require("rxjs");
const http_interface_1 = require("../http.interface");
const responseBody_factory_1 = require("./responseBody.factory");
const responseHeaders_factory_1 = require("./responseHeaders.factory");
const utils_1 = require("../+internal/utils");
const testing_1 = require("../+internal/testing");
exports.handleResponse = (res) => (req) => (effect) => {
    if (res.finished) {
        return rxjs_1.EMPTY;
    }
    const status = effect.status || http_interface_1.HttpStatus.OK;
    const path = url.parse(req.url).pathname || '';
    const headersFactoryWithData = responseHeaders_factory_1.headersFactory({ body: effect.body, path, status });
    const headers = headersFactoryWithData(effect.headers);
    const bodyFactoryWithHeaders = responseBody_factory_1.bodyFactory(headers);
    const body = bodyFactoryWithHeaders(effect.body);
    testing_1.applyMetadata(req, res);
    if (utils_1.isStream(body)) {
        res.writeHead(status, headers);
        body.pipe(res);
    }
    else {
        if (body) {
            res.setHeader('Content-Length', Buffer.byteLength(body));
        }
        res.writeHead(status, headers);
        res.end(body);
    }
    return rxjs_1.EMPTY;
};
