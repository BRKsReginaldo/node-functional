"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const rxjs_1 = require("rxjs");
const operators_1 = require("rxjs/operators");
const core_1 = require("@marblejs/core");
const jwt_util_1 = require("./jwt.util");
const jwt_factory_1 = require("./jwt.factory");
const assignPayloadToRequest = (req) => (payload) => req.user = payload;
exports.authorize$ = (config, verifyPayload$) => req$ => req$.pipe(operators_1.flatMap(req => rxjs_1.of(req).pipe(operators_1.map(jwt_util_1.parseAuthorizationHeader), operators_1.flatMap(jwt_factory_1.verifyToken$(config)), operators_1.flatMap(verifyPayload$), operators_1.tap(assignPayloadToRequest(req)), operators_1.flatMap(() => req$))), operators_1.catchError(() => rxjs_1.throwError(new core_1.HttpError('Unauthorized', core_1.HttpStatus.UNAUTHORIZED))));
